name: Deploy

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT }}
  SERVICE: ${{ secrets.GCP_APP_NAME }}
  REGION: europe-west1

jobs:
    deploy:
        name: Deploy to Google Cloud Run
        runs-on: ubuntu-20.04
        steps:
        - uses: actions/checkout@v2
        - name: Setup Cloud SDK
          uses: google-github-actions/setup-gcloud@v0.3.0
          with:
            project_id: ${{ env.PROJECT_ID }}
            service_account_key: ${{ secrets.GCP_CREDENTIALS }}
            export_default_credentials: true
        - name: Authorize Docker push
          run: gcloud auth configure-docker
        - name: Build and Push Container
          run: |-
            docker build -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:${{  github.sha }} .
            docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:${{  github.sha }}
        - name: Deploy to Cloud Run
          id: deploy
          uses: google-github-actions/deploy-cloudrun@v0.4.0
          with:
            service: ${{ env.SERVICE }}
            image: gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:${{  github.sha }}
            region: ${{ env.REGION }}
        - name: Show Output
          run: echo ${{ steps.deploy.outputs.url }}
